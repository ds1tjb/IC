<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2025í•™ë…„ë„ ë“±êµì§€ë„ ê·œì • ìœ„ë°˜ ê¸°ë¡ ì‹œìŠ¤í…œ</title>
  <style>
    html, body {
      font-family: "Segoe UI", sans-serif;
      background: #f5f7fa;
      color: #333;
      margin: 0;
      padding: 1rem;
      height: 100%;
      overflow: auto;
    }

    h1 {
      color: #4a90e2;
      font-size: 3rem;
      margin-top: 1rem;
    }

    input#studentId {
      font-size: 3rem;
      padding: 1rem;
      text-align: center;
      margin: 2rem 0 1rem 0;
      width: 90%;
      max-width: 600px;
    }

    .keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin: 2rem auto;
      max-width: 600px;
    }

    .keypad button {
      font-size: 3rem;
      padding: 2.5rem;
      border: none;
      border-radius: 1rem;
      background: #dff0fc;
      color: #333;
      transition: 0.2s;
      width: 100%;
    }

    .keypad button:hover {
      background: #b2dcfb;
    }

    .photo {
      width: 300px;
      height: 400px;
      object-fit: cover;
      margin: 1.5rem auto;
      border: 3px dashed #ccc;
    }

    .actions {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      margin-top: 2rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .actions button {
      font-size: 2.5rem;
      padding: 2rem;
      border: none;
      border-radius: 1rem;
      background-color: #ffd166;
      color: #333;
    }

    .return-btn {
      margin-top: 3rem;
      background-color: #ccc;
      font-size: 2.5rem;
      padding: 1.5rem 3rem;
    }

    .admin-button-container {
      margin-top: 2rem;
    }

    #adminModeBtn {
      display: none;
      font-size: 2.5rem;
      padding: 1.5rem 3rem;
    }

    #photoSection, #adminSection {
      display: none;
    }

    table {
      margin: 2rem auto;
      border-collapse: collapse;
      width: 95%;
      max-width: 1000px;
      font-size: 1.8rem;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 1rem;
      text-align: center;
    }

    th {
      background-color: #e8f4fd;
      cursor: pointer;
    }

    th:hover {
      background-color: #c7e3fb;
    }

    #deleteIdInput {
      font-size: 2rem;
      padding: 1rem;
      width: 90%;
      max-width: 400px;
      display: block;
      margin: 1.5rem auto;
    }

    button {
      font-size: 2.2rem;
      padding: 1.2rem 2.5rem;
      border-radius: 1rem;
    }
  </style>
</head>
<body>
  <h1>2025í•™ë…„ë„ ë“±êµì§€ë„ ê·œì • ìœ„ë°˜ ê¸°ë¡ ì‹œìŠ¤í…œ</h1>

  <div id="inputSection">
    <input type="text" id="studentId" placeholder="í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”. (5ìë¦¬)" readonly />
    <div class="keypad" id="keypad"></div>
    <div class="admin-button-container">
      <button id="adminModeBtn" onclick="requestAdminMode()">ê´€ë¦¬ìëª¨ë“œ</button>
    </div>
  </div>

  <div id="photoSection">
    <img id="studentPhoto" class="photo" src="" alt="í•™ìƒ ì‚¬ì§„" />
    <div id="photoMessage" class="student-info"></div>

    <div class="actions">
      <button onclick="addViolation('ë³µì¥ ê·œì • ìœ„ë°˜')">ë³µì¥ ê·œì • ìœ„ë°˜</button>
      <button onclick="addViolation('íƒœë„ ë¶ˆëŸ‰')">íƒœë„ ë¶ˆëŸ‰</button>
      <button onclick="addViolation('ê¸°íƒ€ ìœ„ë°˜')">ê¸°íƒ€ ìœ„ë°˜</button>
    </div>

    <button class="return-btn" onclick="goToStart()">ì²˜ìŒìœ¼ë¡œ</button>
  </div>

  <div id="adminSection">
    <h2>ğŸ“‹ ì „ì²´ ê¸°ë¡ ğŸ“‹</h2>
    <div id="adminLogs"></div>
    <button onclick="downloadCSV()">CSV ë‚´ë³´ë‚´ê¸°</button><br><br>
    <button onclick="clearAllLogs()">ëª¨ë“  ê¸°ë¡ ì‚­ì œ</button><br><br>
    <button onclick="deleteSpecificLog()">íŠ¹ì • í•™ë²ˆ ì‚­ì œ</button>
    <input type="text" id="deleteIdInput" placeholder="ì‚­ì œí•  í•™ë²ˆ ì…ë ¥" /><br>
    <button class="return-btn" onclick="goToStart()">ì²˜ìŒìœ¼ë¡œ</button>
  </div>

  <script>
    const keypad = document.getElementById('keypad');
    const studentIdInput = document.getElementById('studentId');
    const studentPhoto = document.getElementById('studentPhoto');
    const photoMessage = document.getElementById('photoMessage');
    const inputSection = document.getElementById('inputSection');
    const photoSection = document.getElementById('photoSection');
    const adminSection = document.getElementById('adminSection');
    const adminLogs = document.getElementById('adminLogs');
    const adminModeBtn = document.getElementById('adminModeBtn');

    const keys = ['1','2','3','4','5','6','7','8','9','â†','0','í™•ì¸'];
    keys.forEach(key => {
      const btn = document.createElement('button');
      btn.textContent = key;
      btn.onclick = () => {
        if (key === 'â†') studentIdInput.value = studentIdInput.value.slice(0, -1);
        else if (key === 'í™•ì¸') validateId();
        else studentIdInput.value += key;
      };
      keypad.appendChild(btn);
    });

    const studentNames = {
      "20231234": "í™ê¸¸ë™",
      "20239876": "ê¹€ì² ìˆ˜"
    };

    function validateId() {
      const id = studentIdInput.value;
      if (!id) return alert('í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”.');
      inputSection.style.display = 'none';
      photoSection.style.display = 'block';
      adminModeBtn.style.display = 'none';
      loadPhoto(id);
      showStudentHistory(id);
    }

    function loadPhoto(id) {
      const imgPath = `images/${id}.jpg`;
      studentPhoto.src = imgPath;

      studentPhoto.onerror = () => {
        studentPhoto.src = 'images/default.jpg';
        photoMessage.innerHTML = `<p>ì‚¬ì§„ì´ ì—†ì–´ ê¸°ë³¸ ì´ë¯¸ì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</p><p>í•™ë²ˆ: ${id}</p>`;
      };

      studentPhoto.onload = () => {
        photoMessage.innerHTML = `<p>í•™ë²ˆ: ${id}</p>`;
        showStudentHistory(id);
      };
    }

    function showStudentHistory(id) {
      const log = JSON.parse(localStorage.getItem(`log_${id}`) || '[]');
      if (log.length > 0) {
        const historyHTML = log.map(l => `ğŸ“Œ ${l.timestamp} - ${l.reason}`).join('<br>');
        photoMessage.innerHTML += `<div style="margin-top: 1rem;"><strong>ì´ì „ ê¸°ë¡:</strong><br>${historyHTML}</div>`;
      }
    }

    function addViolation(reason) {
      const id = studentIdInput.value;
      if (!id) return alert('í•™ë²ˆì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.');
      const timestamp = new Date().toLocaleString();
      const key = `log_${id}`;
      const log = JSON.parse(localStorage.getItem(key) || '[]');
      log.push({ timestamp, reason });
      localStorage.setItem(key, JSON.stringify(log));
      alert(`${reason} ê¸°ë¡ë¨`);
      setTimeout(goToStart, 2000);
    }

    function goToStart() {
      studentIdInput.value = '';
      inputSection.style.display = 'block';
      photoSection.style.display = 'none';
      adminSection.style.display = 'none';
      adminModeBtn.style.display = 'block';
    }

    function requestAdminMode() {
      const pwd = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
      if (pwd === '11200') {
        inputSection.style.display = 'none';
        photoSection.style.display = 'none';
        adminSection.style.display = 'block';
        adminModeBtn.style.display = 'none';
        viewAllLogs();
      } else {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤');
      }
    }

    function viewAllLogs() {
      const logs = [];
      for (let key in localStorage) {
        if (key.startsWith('log_')) {
          const id = key.replace('log_', '');
          const name = studentNames[id] || '';
          const data = JSON.parse(localStorage.getItem(key));
          data.forEach(entry => {
            logs.push({ id, name, timestamp: entry.timestamp, reason: entry.reason });
          });
        }
      }
      renderTable(logs);
    }

    function renderTable(logs) {
      let table = `<table><thead><tr>
        <th onclick="sortTable('id')">í•™ë²ˆ</th>
        <th onclick="sortTable('name')">ì„±ëª…</th>
        <th onclick="sortTable('timestamp')">ì¼ì‹œ</th>
        <th onclick="sortTable('reason')">ì‚¬ìœ </th>
      </tr></thead><tbody>`;

      logs.forEach(row => {
        table += `<tr>
          <td>${row.id}</td>
          <td>${row.name}</td>
          <td>${row.timestamp}</td>
          <td>${row.reason}</td>
        </tr>`;
      });

      table += '</tbody></table>';
      adminLogs.innerHTML = table;
      window.currentLogs = logs;
    }

    let sortOrder = 1;
    let sortColumn = null;

    function sortTable(column) {
      if (sortColumn === column) sortOrder *= -1;
      else {
        sortColumn = column;
        sortOrder = 1;
      }

      const sorted = [...window.currentLogs].sort((a, b) => {
        if (a[column] < b[column]) return -1 * sortOrder;
        if (a[column] > b[column]) return 1 * sortOrder;
        return 0;
      });
      renderTable(sorted);
    }

    function downloadCSV() {
      let csv = 'í•™ë²ˆ,ì„±ëª…,ì¼ì‹œ,ì‚¬ìœ \n';
      for (let key in localStorage) {
        if (key.startsWith('log_')) {
          const id = key.replace('log_', '');
          const logs = JSON.parse(localStorage.getItem(key));
          logs.forEach(log => {
            csv += `${id},${studentNames[id] || ''},${log.timestamp},${log.reason}\n`;
          });
        }
      }

      const bom = "\uFEFF";
      const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'student_logs.csv';
      a.click();
    }

    function clearAllLogs() {
      if (confirm('ì •ë§ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        for (let key in localStorage) {
          if (key.startsWith('log_')) {
            localStorage.removeItem(key);
          }
        }
        alert('ëª¨ë“  ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        viewAllLogs();
      }
    }

    function deleteSpecificLog() {
      const id = document.getElementById('deleteIdInput').value.trim();
      if (!id) return alert('í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”.');
      const key = `log_${id}`;
      if (localStorage.getItem(key)) {
        localStorage.removeItem(key);
        alert(`${id}ë²ˆ í•™ë²ˆ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        viewAllLogs();
      } else {
        alert(`í•´ë‹¹ í•™ë²ˆì— ëŒ€í•œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.`);
      }
    }

    window.onload = () => {
      adminModeBtn.style.display = 'block';
    };
  </script>
</body>
</html>
