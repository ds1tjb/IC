<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2025학년도 등교지도 규정 위반 기록 시스템</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f5f7fa;
      color: #333;
      text-align: center;
      margin: 0;
      padding: 1rem;
    }
    h1 {
      color: #4a90e2;
      font-size: 1.8rem;
    }
    .photo {
      width: 200px;
      height: 260px;
      object-fit: cover;
      margin: 1rem auto;
      border: 2px dashed #ccc;
    }
    .keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin: 1rem auto;
      max-width: 300px;
    }
    .keypad button {
      font-size: 1.5rem;
      padding: 1rem;
      border: none;
      border-radius: 10px;
      background: #dff0fc;
      color: #333;
      transition: 0.2s;
    }
    .keypad button:hover {
      background: #b2dcfb;
    }
    input#studentId {
      font-size: 1.5rem;
      padding: 0.5rem;
      text-align: center;
      margin-bottom: 1rem;
      width: 80%;
    }
    .actions {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .actions button {
      flex: 1 0 30%;
      min-width: 150px;
      max-width: 200px;
      font-size: 1.2rem;
      padding: 0.8rem 1.2rem;
      border: none;
      border-radius: 8px;
      background-color: #ffd166;
      color: #333;
    }
    button {
      font-size: 1.2rem;
      padding: 0.8rem 1.2rem;
      border: none;
      border-radius: 8px;
      background-color: #ffd166;
      color: #333;
    }
    #adminModeBtn {
      display: none;
      margin-top: 2rem;
    }
    .admin-button-container {
      text-align: center;
      margin-top: 2rem;
    }
    #photoSection, #adminSection {
      display: none;
    }
    .return-btn {
      margin-top: 2rem;
      background-color: #ccc;
    }
    table {
      margin: 1rem auto;
      border-collapse: collapse;
      width: 95%;
      max-width: 800px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.6rem;
      text-align: center;
    }
    th {
      background-color: #e8f4fd;
      cursor: pointer;
    }
    th:hover {
      background-color: #c7e3fb;
    }
  </style>
</head>
<body>
  <h1>2025학년도 등교지도 규정 위반 기록 시스템</h1>

  <div id="inputSection">
    <input type="text" id="studentId" placeholder="학번을 입력하세요. (5자리)" readonly />
    <div class="keypad" id="keypad"></div>
    <div class="admin-button-container">
      <center><button id="adminModeBtn" onclick="requestAdminMode()">관리자모드</button></center>
    </div>
  </div>

  <div id="photoSection">
    <img id="studentPhoto" class="photo" src="" alt="학생 사진" />
    <div id="photoMessage" class="student-info"></div>

    <div class="actions">
      <button onclick="addViolation('복장 규정 위반')">복장 규정 위반</button>
      <button onclick="addViolation('태도 불량')">태도 불량</button>
      <button onclick="addViolation('기타 위반')">기타 위반</button>
    </div>

    <button class="return-btn" onclick="goToStart()">처음으로</button>
  </div>

  <div id="adminSection">
    <h2>📋 전체 기록 📋</h2>
    <div id="adminLogs"></div>
    <button onclick="downloadCSV()">CSV 내보내기</button><br><br>
    <button onclick="clearAllLogs()">모든 기록 삭제</button> <br><br>
    <button onclick="deleteSpecificLog()">특정 학번 삭제</button>
   <input 
  type="text" 
  id="deleteIdInput" 
  placeholder="삭제할 학번 입력" 
  style="margin: 1rem auto; padding: 0.9rem; font-size: 1rem; display: block; min-width: 200px; max-width: 300px; width: 80%;" 
/><br>
    <button class="return-btn" onclick="goToStart()">처음으로</button>
  </div>

  <script>
    const keypad = document.getElementById('keypad');
    const studentIdInput = document.getElementById('studentId');
    const studentPhoto = document.getElementById('studentPhoto');
    const photoMessage = document.getElementById('photoMessage');
    const inputSection = document.getElementById('inputSection');
    const photoSection = document.getElementById('photoSection');
    const adminSection = document.getElementById('adminSection');
    const adminLogs = document.getElementById('adminLogs');
    const adminModeBtn = document.getElementById('adminModeBtn');

    const keys = ['1','2','3','4','5','6','7','8','9','←','0','확인'];
    keys.forEach(key => {
      const btn = document.createElement('button');
      btn.textContent = key;
      btn.onclick = () => {
        if (key === '←') studentIdInput.value = studentIdInput.value.slice(0, -1);
        else if (key === '확인') validateId();
        else studentIdInput.value += key;
      };
      keypad.appendChild(btn);
    });

    const studentNames = {
      "20231234": "홍길동",
      "20239876": "김철수"
    };

    function validateId() {
      const id = studentIdInput.value;
      if (!id) return alert('학번을 입력하세요.');
      inputSection.style.display = 'none';
      photoSection.style.display = 'block';
      adminModeBtn.style.display = 'none';
      loadPhoto(id);
      showStudentHistory(id);
    }

    function loadPhoto(id) {
      const imgPath = `images/${id}.jpg`;
      studentPhoto.src = imgPath;

      studentPhoto.onerror = () => {
        studentPhoto.src = 'images/default.jpg';
        photoMessage.innerHTML = `<p>사진이 없어 기본 이미지를 표시합니다.</p><p>학번: ${id}</p>`;
      };

      studentPhoto.onload = () => {
        photoMessage.innerHTML = `<p>학번: ${id}</p>`;
      };
    }

    function showStudentHistory(id) {
      const log = JSON.parse(localStorage.getItem(`log_${id}`) || '[]');
      if (log.length > 0) {
        const historyHTML = log.map(l => `📌 ${l.timestamp} - ${l.reason}`).join('<br>');
        photoMessage.innerHTML += `<div style="margin-top: 0.5rem;"><strong>이전 기록:</strong><br>${historyHTML}</div>`;
      }
    }

    function addViolation(reason) {
      const id = studentIdInput.value;
      if (!id) return alert('학번을 먼저 입력하세요.');
      const timestamp = new Date().toLocaleString();
      const key = `log_${id}`;
      const log = JSON.parse(localStorage.getItem(key) || '[]');
      log.push({ timestamp, reason });
      localStorage.setItem(key, JSON.stringify(log));
      alert(`${reason} 기록됨`);
      setTimeout(goToStart, 2000);
    }

    function goToStart() {
      studentIdInput.value = '';
      inputSection.style.display = 'block';
      photoSection.style.display = 'none';
      adminSection.style.display = 'none';
      adminModeBtn.style.display = 'block';
    }

    function requestAdminMode() {
      const pwd = prompt('관리자 비밀번호를 입력하세요');
      if (pwd === '11200') {
        inputSection.style.display = 'none';
        photoSection.style.display = 'none';
        adminSection.style.display = 'block';
        adminModeBtn.style.display = 'none';
        viewAllLogs();
      } else {
        alert('비밀번호가 틀렸습니다');
      }
    }

    function viewAllLogs() {
      const logs = [];
      for (let key in localStorage) {
        if (key.startsWith('log_')) {
          const id = key.replace('log_', '');
          const name = studentNames[id] || '';
          const data = JSON.parse(localStorage.getItem(key));
          data.forEach(entry => {
            logs.push({ id, name, timestamp: entry.timestamp, reason: entry.reason });
          });
        }
      }
      renderTable(logs);
    }

    function renderTable(logs) {
      let table = `<table><thead><tr>
        <th onclick="sortTable('id')">학번</th>
        <th onclick="sortTable('name')">성명</th>
        <th onclick="sortTable('timestamp')">일시</th>
        <th onclick="sortTable('reason')">사유</th>
      </tr></thead><tbody>`;

      logs.forEach(row => {
        table += `<tr>
          <td>${row.id}</td>
          <td>${row.name}</td>
          <td>${row.timestamp}</td>
          <td>${row.reason}</td>
        </tr>`;
      });

      table += '</tbody></table>';
      adminLogs.innerHTML = table;
      window.currentLogs = logs;
    }

    let sortOrder = 1;
    let sortColumn = null;

    function sortTable(column) {
      if (sortColumn === column) sortOrder *= -1;
      else {
        sortColumn = column;
        sortOrder = 1;
      }

      const sorted = [...window.currentLogs].sort((a, b) => {
        if (a[column] < b[column]) return -1 * sortOrder;
        if (a[column] > b[column]) return 1 * sortOrder;
        return 0;
      });
      renderTable(sorted);
    }

    function downloadCSV() {
      let csv = '학번,성명,일시,사유\n';
      for (let key in localStorage) {
        if (key.startsWith('log_')) {
          const id = key.replace('log_', '');
          const logs = JSON.parse(localStorage.getItem(key));
          logs.forEach(log => {
            csv += `${id},${studentNames[id] || ''},${log.timestamp},${log.reason}\n`;
          });
        }
      }

      const bom = "\uFEFF";
      const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'student_logs.csv';
      a.click();
    }

    function clearAllLogs() {
      if (confirm('정말 모든 기록을 삭제하시겠습니까? 되돌릴 수 없습니다.')) {
        for (let key in localStorage) {
          if (key.startsWith('log_')) {
            localStorage.removeItem(key);
          }
        }
        alert('모든 기록이 삭제되었습니다.');
        viewAllLogs();
      }
    }

    function deleteSpecificLog() {
      const id = document.getElementById('deleteIdInput').value.trim();
      if (!id) return alert('학번을 입력하세요.');
      const key = `log_${id}`;
      if (localStorage.getItem(key)) {
        localStorage.removeItem(key);
        alert(`${id}번 학번 기록이 삭제되었습니다.`);
        viewAllLogs();
      } else {
        alert(`해당 학번에 대한 기록이 없습니다.`);
      }
    }

    window.onload = () => {
      adminModeBtn.style.display = 'block';
    };
  </script>
</body>
</html>
